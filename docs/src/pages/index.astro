---
import Base from "@/layouts/Base.astro";
import config from "@/config/config.json";

import Header from "../old/components/Header.astro";
import Navigation from "../old/components/Navigation.astro";
import NavigationLink from "../old/components/NavigationLink.astro";

import Notification from "../old/components/Notification.astro";
import AppStore from "../old/components/AppStore.astro";
import Reviews from "../old/components/Reviews.astro";
import Features from "../old/components/Features.astro";
import StatusBar from "../old/components/StatusBar.astro";
import TeamInsights from "../old/components/TeamInsights.astro";
import SocialMediaMentions from "../old/components/SocialMediaMentions.astro";
import SubscribeToNewsletter from "../old/components/SubscribeToNewsletter.astro";
import SupportAndFeedback from "../old/components/SupportAndFeedback.astro";

import logoImage from "../assets/rocketsim-logo.svg";

const {
  site: { base_url },
} = config;
---

<Base canonical={`${base_url}`}>
  <Notification />
  <Header
    title="Enhancing the Xcode Simulators"
    logo={logoImage}
    logoAlt='Written logo spelling: "RocketSim"'
    scrollText="Scroll down to explore all features â†“"
  >
    Boost your productivity and streamline your workflow with our <strong
      >powerful Xcode Simulator tools</strong
    >. Developers report building, testing, and verifying apps <strong
      >up to 2x faster</strong
    > with RocketSim.
  </Header>
  <Navigation>
    <NavigationLink
      href="https://apps.apple.com/app/apple-store/id1504940162?pt=117264678&ct=website-header&mt=8"
      className="plausible-event-name=App+Store+Install"
      id="js-header-app-store-button"
      asButton
      target="_blank"
    >
      Download now
    </NavigationLink>
    <NavigationLink
      href="/team-insights"
      className="plausible-event-name=cta_click plausible-event-page=homepage plausible-event-cta_type=team plausible-event-position=hero plausible-event-button_text=Team+Licenses"
      >Team Licenses</NavigationLink
    >
  </Navigation>
  <AppStore />
  <Reviews />
  <SubscribeToNewsletter />
  <Features />
  <TeamInsights />
  <StatusBar />
  <SubscribeToNewsletter />
  <SocialMediaMentions />
  <SupportAndFeedback />
</Base>

<!-- Script to set the button URL using the UTM Campaign -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);

    let referer = null;

    // First see if we already have a referer stored. We want to use the first-referer possible.
    if (!referer) {
      const cookies = document.cookie.split(";");
      cookies.forEach((cookie) => {
        const [name, value] = cookie.trim().split("=");
        if (name === "referer") {
          referer = decodeURIComponent(value);
        }
      });
    }

    // Even if we fetched the cookie value, we want new campaigns or refs to take over.
    referer = urlParams.get("utm_campaign") || urlParams.get("ref") || referer;

    // If referer is not set, try using referer header as referer.
    if (!referer) {
      const refererHeader = document.referrer;
      if (refererHeader) {
        const refererHost = new URL(refererHeader).hostname;
        if (refererHost) {
          referer = refererHost;
        }
      }
    }

    // Remember referer for future usage.
    if (referer) {
      // Set cookie expiration time to now + 60 minutes
      const expirationTime = new Date(
        Date.now() + 7 * 24 * 60 * 60 * 1000,
      ).toUTCString();

      // Format cookie string
      const cookieString = `referer=${encodeURIComponent(referer)}; expires=${expirationTime}; path=/`;

      // Set cookie
      document.cookie = cookieString;
    }

    // Use the referer as the campaign or fallback to 'website-header'
    const campaign = referer || "website-header";

    const a = document.getElementById("js-header-app-store-button");

    if (a instanceof HTMLAnchorElement) {
      a.href =
        "https://apps.apple.com/app/apple-store/id1504940162?pt=117264678&ct=" +
        encodeURIComponent(campaign) +
        "&mt=8";
    }

    plausible("Stored Referer", { props: { stored_referer: campaign } });
  });
</script>
