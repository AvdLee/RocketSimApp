---
import { JSDOM } from "jsdom";
import { Image } from "astro:assets";

import Base from "@/layouts/Base.astro";
import config from "@/config/config.json";
import { selectOgImage } from "@/lib/utils/selectOgImage";
import { dateFormat } from "@/lib/utils/dateFormat";

const { slug } = Astro.params;

export async function getStaticPaths() {
  const blogBaseUrl = config.blog.base_url;

  let data = await fetch(`${blogBaseUrl}/wp-json/wp/v2/posts`);
  let posts = (await data.json()) as Array<{ slug: string }>;

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post: post },
  }));
}

let post;

const blogBaseUrl = config.blog.base_url;

try {
  const res = await fetch(
    `${blogBaseUrl}/wp-json/wp/v2/posts?slug=${slug}&_embed`,
  );
  [post] = await res.json();
} catch (e) {
  throw new Error(
    `Failed to fetch blog post for slug "${slug}" from "${blogBaseUrl}/wp-json/wp/v2/posts?slug=${slug}&_embed": ${e instanceof Error ? e.message : String(e)}`,
  );
}

const title = post.title.rendered;
const articlePublishedTime = post.date;
const articleModifiedTime = post.modified;

// Extract featured image data
const featuredMedia = post._embedded?.["wp:featuredmedia"]?.[0];
const image = featuredMedia
  ? selectOgImage(featuredMedia.media_details.sizes)
  : undefined;

// Extract Yoast SEO data
const yoast = post.yoast_head_json || {};
const description = yoast.og_description || yoast.description || post.excerpt?.rendered || "";

// Extract robots meta settings from Yoast
const robotsMeta = yoast.robots || {};
const robots = {
  index: robotsMeta.index !== "noindex",
  follow: robotsMeta.follow !== "nofollow",
  ...(robotsMeta["max-snippet"] && { maxSnippet: parseInt(robotsMeta["max-snippet"]) }),
  ...(robotsMeta["max-image-preview"] && { maxImagePreview: robotsMeta["max-image-preview"] }),
  ...(robotsMeta["max-video-preview"] && { maxVideoPreview: parseInt(robotsMeta["max-video-preview"]) }),
};

// Extract Twitter metadata
const twitterCreator = yoast.twitter_misc?.["Written by"] ? "@twannl" : "@twannl";
const twitterSite = yoast.twitter_site || "@rocketsim_app";

// Extract word count from schema data
let wordCount: number | undefined;
if (yoast.schema?.["@graph"]) {
  const articleSchema = yoast.schema["@graph"].find((item: any) => item["@type"] === "Article");
  if (articleSchema?.wordCount) {
    wordCount = articleSchema.wordCount;
  }
}

const {
  site: { base_url },
} = config;

// Build canonical URL (transform from cms.rocketsim.app to rocketsim.app)
const canonicalUrl = `https://rocketsim.app/blog/${post.slug}`;

// Build SEO object for SEO component
const seo = {
  title: `${title} - RocketSim`,
  description,
  image, // Keep cms.rocketsim.app domain for images
  canonical: canonicalUrl,
  robots,
  twitterCreator,
  twitterSite,
  article: {
    publishedTime: articlePublishedTime,
    modifiedTime: articleModifiedTime,
    wordCount,
  },
};

// Build structured data object for StructuredData component
const structuredData = {
  type: "article" as const,
  article: {
    headline: title,
    description,
    datePublished: articlePublishedTime,
    dateModified: articleModifiedTime,
    wordCount,
    image: image ? {
      url: image, // Keep cms.rocketsim.app domain for images
      width: featuredMedia?.media_details?.width,
      height: featuredMedia?.media_details?.height,
      caption: featuredMedia?.caption?.rendered,
    } : undefined,
    url: canonicalUrl,
    slug: post.slug,
  },
};

/**
 * Manipulate the post content in any way you want here.
 */
const dom = new JSDOM(post.content.rendered);
const doc = dom.window.document;

const videos = doc.querySelectorAll("video");

videos.forEach((video) => {
  video.setAttribute("playsinline", "true");
  video.setAttribute("controls", "true");
});

const manipulatedDom = dom.serialize();
---

<Base
  seo={seo}
  structuredData={structuredData}
>
  <article>
    <header>
      <div class="ph-spacing">
        <div class="container text-center">
          <div class="flex flex-col items-center gap-16 lg:gap-28">
            <div class="space-y-3 md:space-y-5 mx-auto">
              {
                articleModifiedTime && (
                  <p
                    class="text-center text-base font-medium text-text pb-2"
                    data-aos="fade-up-sm"
                    data-aos-delay="0"
                  >
                    Last Updated
                    <span
                      set:html={dateFormat(
                        articleModifiedTime,
                        " MMM dd, yyyy",
                      )}
                    />
                  </p>
                )
              }
              <h1
                class="page-heading leading-none text-center !mb-6"
                data-aos="fade-up-sm"
                data-aos-delay="50"
                set:html={title}
              />
            </div>
          </div>
        </div>
      </div>

      {
        image ? (
          <div class="ph-merged-section">
            <div class="container">
              <figure data-aos="fade-up-sm" data-aos-delay="150">
                <Image
                  src={image}
                  alt={title}
                  width={1300}
                  height={768}
                  class="w-full max-h-[580px] object-cover rounded-2xl"
                />
              </figure>
            </div>
          </div>
        ) : null
      }
    </header>

    <section class="section -mt-20">
      <div class="container">
        <div class="content xl:px-32">
          <Fragment set:html={manipulatedDom} />
        </div>
      </div>
    </section>
  </article>
</Base>
